<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <link href="../siteicon.png" rel="apple-touch-icon" type="image/png"/>
    <meta content="m2ag.labs iot client" name="apple-mobile-web-app-title">
    <link href="../siteicon.png" rel="shortcut icon" type="image/png"/>
    <link href="../siteicon.png" rel="mask-icon" type=""/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" rel="stylesheet"/>
    <link crossorigin="anonymous" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" rel="stylesheet">
    <title>m2ag.labs.iot</title>
</head>
<body>

<div class="container-fluid">

    <!--ui page -->
    <div aria-labelledby="pills-ui-tab" class="tab-pane fade show" id="ui" role="tabpanel">
        <div class="row vw-100">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <ul class="list-group text-left">
                        </ul>
                    </div>
                </div>

            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <ul class="list-group text-left">
                            <li class="list-group-item text-center" id="display_controls">
                                <button class="btn btn-success" id="camera_start" type="button">
                                    Start Video
                                </button>
                                <button class="btn btn-danger" id="camera_stop" type="button">
                                    Stop Video
                                </button>
                            </li>
                            <li class="list-group-item  text-center" id="display_data_display">

                            </li>
                            <li class="list-group-item  text-center" id="display">
                                <img alt="not connected" id="display_image" src=""
                                     style="width:100%">
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <ul class="list-group text-left">
                            <li class="list-group-item text-center" id="camera_controls">
                                <button class="btn btn-success" id="pan_tilt_center" type="button">
                                    Center Pan/Tilt
                                </button>
                            </li>
                            <li class="list-group-item  text-center" id="camera_data_display">

                            </li>
                            <li class="list-group-item  text-center" id="camera" style="min-height: 500px;">

                            </li>
                        </ul>
                    </div>
                </div>
            </div>


        </div><!-- row -->
    </div>


</div> <!-- container main content-->


<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script crossorigin="anonymous"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script crossorigin="anonymous"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>


<script src="./js/nipplejs.js"></script>

<script src="../js/api.js"></script>
<script src="../js/comm.js"></script>

<script>

    window.addEventListener("load", init);

    let index;
    let params = {};

    let cmd_stub = {
        "messageType": "setProperty",
        "data": {}
    };

    let raspi_cam_socket;

    const scale = (num, in_min, in_max, out_min, out_max) => {
        return (num - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
    };

    function init() {
        //TODO: get the path from thing data
        getThing().then(data=>{ getCallback(data)})
    }

    function getCallback(thing) {

        //We need to identify the pca9685 and set the current pan and tilt
        for (let i = 0; i < thing.length; i++) {
            //is this the pca9685 ?
            if (thing[i].id.includes('raspicam')) {
                index = i
                raspi_cam_socket = getWebSocket(`/${i}`,{ on_message: raspi_cam_message})
                getThing(`${i}/properties`).then(data=>{ setRaspiCam(data)})
                setDefaults(thing[i]['properties'])
            }
        }
    }
    //updates from the websocket -- do I really need this?
    function raspi_cam_message(evt){
        //TODO: update last position here.
        //console.log(evt.data);
    }

    function setDefaults(data) {
        //console.log(data);
        for (const param in data) {
            if (data.hasOwnProperty(param)) {
                params[param] = data[param];
            }
        }
    }

    function setRaspiCam(init) {
        // console.log(data);
        setTimeout(() => {
            cameraPositionInit(init);
            cameraStartStopInit();
        }, 1000);
    }


    /**
     * Camera Pan/Tilt
     **/

    const camera = nipplejs.create({
        zone: document.getElementById('camera'),
        mode: 'semi',
        color: 'red',
        size: 200
    });

    let cameraPanTiltCmd = {
        "pan": 150,
        "tilt": 150
    };
    let current_move = {pan: 0, tilt: 0};
    let camera_move_interval;
    let joystick_center = 5;

    function cameraPositionInit(data) {

        document.getElementById("pan_tilt_center").onclick = centerCamera;

        if (data.pan > params.pan.maximum || data.pan < params.pan.minimum) {
            cameraPanTiltCmd.pan = params.pan.init;
        } else {
            cameraPanTiltCmd.pan = data.pan;
        }

        if (data.tilt > params.tilt.maximum || data.tilt < params.tilt.minimum) {
            cameraPanTiltCmd.tilt = params.tilt.init;
        } else {
            cameraPanTiltCmd.tilt = data.tilt;
        }
        cmd_stub.data = cameraPanTiltCmd;
        wssSend(cmd_stub, raspi_cam_socket);


        camera.on('start', () => {
            camera_move_interval = setInterval(() => {
                moveCamera(current_move.tilt, current_move.pan);
            }, 250);
        }).on('end', function () {
            clearInterval(camera_move_interval);
            camera.options.lockX = false;
            camera.options.lockY = false;
        }).on('move', function (evt, data) {
            current_move.pan = -data.instance.frontPosition.x;
            current_move.tilt = data.instance.frontPosition.y;
            //Allows joystick to change direction in when it is in center
            if (Math.abs(current_move.tilt) < joystick_center && Math.abs(current_move.pan) < joystick_center) {
                camera.options.lockX = false;
                camera.options.lockY = false;
            }
        }).on('dir:up dir:down', function () {
            if (!(camera.options.lockX || camera.options.lockY)) {
                camera.options.lockY = true;
            }
        }).on('dir:left dir:right', function () {
            if (!(camera.options.lockX || camera.options.lockY)) {
                camera.options.lockX = true;
            }
        });
    }

    function moveCamera(tilt, pan) {
        //Get the latest position from the last data_object
        let _pan = cameraPanTiltCmd.pan;
        let _tilt = cameraPanTiltCmd.tilt;
        _pan += scale(Math.floor(pan), 0, 100, 0, 5);
        if (_pan < params.pan['minimum']) _pan = params.pan['minimum'];
        if (_pan > params.pan['maximum']) _pan = params.pan['maximum'];
        _tilt += scale(Math.floor(tilt), 0, 100, 0, 5);
        if (_tilt < params.tilt['minimum']) _tilt = params.tilt['minimum'];
        if (_tilt > params.tilt['maximum']) _tilt = params.tilt['maximum'];

        cameraPanTiltCmd.pan = Math.floor(_pan);
        cameraPanTiltCmd.tilt = Math.floor(_tilt);
        cmd_stub.data = cameraPanTiltCmd;
        wssSend(cmd_stub, raspi_cam_socket);
    }

    function centerCamera() {
        //TODO: Get the zeros for pan and tilt from the config.

        //cameraPanTiltCmd.pan = params.pan.init;
        cameraPanTiltCmd.pan = 150;
        //cameraPanTiltCmd.tilt = params.tilt.init;
        cameraPanTiltCmd.tilt = 150;
        cmd_stub.data = cameraPanTiltCmd;
        wssSend(cmd_stub, raspi_cam_socket);
    }


    /***
     * Cameras on/off
     */

    function cameraStartStopInit() {

        document.getElementById('camera_start').onclick = () => {
            document.getElementById("display_image").src = window.location.origin + ':5000/video';
        }

        document.getElementById('camera_stop').onclick = () => {
            document.getElementById("display_image").src = window.location.origin + "/siteicon.png";
        }
        document.getElementById("display_image").src = window.location.origin + ':5000/video';
    }


</script>
</body>
</html>








