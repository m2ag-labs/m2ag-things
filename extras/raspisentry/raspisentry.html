<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <link href="../siteicon.png" rel="apple-touch-icon" type="image/png"/>
    <meta content="m2ag.labs iot client" name="apple-mobile-web-app-title">
    <link href="../siteicon.png" rel="shortcut icon" type="image/png"/>
    <link href="../siteicon.png" rel="mask-icon" type=""/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" rel="stylesheet"/>
    <link crossorigin="anonymous" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" rel="stylesheet">
    <title>m2ag.labs.iot</title>
</head>
<body>

<div class="container-fluid">

    <!--ui page -->
    <div aria-labelledby="pills-ui-tab" class="tab-pane fade show" id="ui" role="tabpanel">
        <div class="row vw-100">
            <div class="col-md-3">
                <div class="card">

                    <div class="card-body">
                        <ul class="list-group text-left">
                            <li class="list-group-item text-center" id="track_controls">
                                <button class="btn btn-info" id="track_rotate_left" style="width: 45%"
                                        type="button">
                                    R-Left
                                </button>
                                <button class="btn btn-info" id="track_rotate_right" style="width: 45%"
                                        type="button">
                                    R-Right
                                </button>
                            </li>
                            <li class="list-group-item  text-center" id="track_data_display">

                            </li>
                            <li class="list-group-item  text-center" id="track" style="min-height: 500px;">

                            </li>
                            <li class="list-group-item text-center">
                                <button class="btn btn-danger" id="track_all_stop" style="width: 100%"
                                        type="button">
                                    All Stop
                                </button>
                            </li>
                        </ul>
                    </div>


                </div>

            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <ul class="list-group text-left">
                            <li class="list-group-item text-center" id="display_controls">
                                <button class="btn btn-success" id="camera_start" type="button">
                                    Start Video
                                </button>
                                <button class="btn btn-danger" id="camera_stop" type="button">
                                    Stop Video
                                </button>
                            </li>
                            <li class="list-group-item  text-center" id="display_data_display">

                            </li>
                            <li class="list-group-item  text-center" id="display">
                                <img alt="not connected" id="display_image" src=""
                                     style="width:100%">
                            </li>
                            <li class="list-group-item list-group-item-success text-center"
                                id="device_logic_voltage_element">
                                <h6>logic: <span id="logic_voltage_status">0.0</span> volts</h6>
                            </li>
                            <li class="list-group-item list-group-item-success text-center"
                                id="device_motor_voltage_element">
                                <h6>motor: <span id="motor_voltage_status">0.0</span> volts</h6>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <ul class="list-group text-left">
                            <li class="list-group-item text-center" id="camera_controls">
                                <button class="btn btn-success" id="pan_tilt_center" type="button">
                                    Center Pan/Tilt
                                </button>
                            </li>
                            <li class="list-group-item  text-center" id="camera_data_display">

                            </li>
                            <li class="list-group-item  text-center" id="camera" style="min-height: 500px;">

                            </li>
                        </ul>
                    </div>
                </div>
            </div>


        </div><!-- row -->
    </div>


</div> <!-- container main content-->


<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script crossorigin="anonymous"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script crossorigin="anonymous"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>


<script src="js/nipplejs.js"></script>


<script src="../js/api.js"></script>
<script src="../js/comm.js"></script>
<script>

    let cmd_stub = {
        "messageType": "setProperty",
        "data": {}
    };

    let sentry_socket;

    const scale = (num, in_min, in_max, out_min, out_max) => {
        return (num - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
    };

    window.addEventListener("load", sentryInit);

    function sentryInit() {
        //TODO: get the path from thing data
        getThing().then(data => {
            sentry_init(data)
        });
    }

    let pca_index;
    let ads_index;

    function sentry_init(thing) {

        //We need to identify the pca9685 and set the current pan and tilt
        // identify ads for battery levels
        for (let i = 0; i < thing.length; i++) {
            //is this the pca9685 ?
            if (thing[i].id.includes('pca9685')) {
                pca_index = i
                sentry_socket = getWebSocket(`/${i}`)
                getThing(`${i}/properties`).then(data => {
                    setPca(data)
                })
                setPcaDefaults(thing[i]['properties'])
            }
            if (thing[i].id.includes('ads1x15')) {
                ads_index = i
                getThing(`${i}/properties`).then(data=>{ setAds(data)})
                //TODO: set defaults //
                ads_interval = setInterval(() => {
                    getThing(`${i}/properties`).then(data=>{ setAds(data)})
                }, 5000)
            }
        }
    }

    //TODO: get initial setting for the pca controller
    let pca_params = {};

    function setPcaDefaults(data) {
        //console.log(data);
        for (const param in data) {
            if (data.hasOwnProperty(param)) {
                pca_params[param] = data[param];
            }
        }
    }


    function setPca(init) {
        // console.log(data);

        setTimeout(() => {
            trackInit();
            cameraPositionInit(init)
            cameraStartStopInit()
        }, 1000);
    }

    //Gonna poll the ads for voltage info. Set green yellow red on the field at certain levels.
    let ads_interval;

    //TODO: get channel -> name (look in data)
    function setAds(thing) {
        //console.log(data);
        document.getElementById('logic_voltage_status').innerText = thing['ch1'].toPrecision(3);
        document.getElementById('motor_voltage_status').innerText = thing['ch0'].toPrecision(3);
    }


    /**
     * Camera Pan/Tilt
     **/

    const camera = nipplejs.create({
        zone: document.getElementById('camera'),
        mode: 'semi',
        color: 'red',
        size: 200
    });

    let cameraPanTiltCmd = {
        "pan": 5000,
        "tilt": 6000
    };
    let current_move = {pan: 0, tilt: 0};
    let camera_move_interval;
    let joystick_center = 5;

    function cameraPositionInit(data) {

        document.getElementById("pan_tilt_center").onclick = centerCamera;

        if (data.pan > pca_params.pan.maximum || data.pan < pca_params.pan.minimum) {
            cameraPanTiltCmd.pan = pca_params.pan.init;
        } else {
            cameraPanTiltCmd.pan = data.pan;
        }

        if (data.tilt > pca_params.tilt.maximum || data.tilt < pca_params.tilt.minimum) {
            cameraPanTiltCmd.tilt = pca_params.tilt.init;
        } else {
            cameraPanTiltCmd.tilt = data.tilt;
        }
        cmd_stub.data = cameraPanTiltCmd;
        wssSend(cmd_stub, sentry_socket);


        camera.on('start', () => {
            camera_move_interval = setInterval(() => {
                moveCamera(current_move.tilt, current_move.pan);
            }, 50);
        }).on('end', function () {
            clearInterval(camera_move_interval);
            camera.options.lockX = false;
            camera.options.lockY = false;
        }).on('move', function (evt, data) {
            current_move.pan = -data.instance.frontPosition.x;
            current_move.tilt = data.instance.frontPosition.y;
            //Allows joystick to change direction in when it is in center
            if (Math.abs(current_move.tilt) < joystick_center && Math.abs(current_move.pan) < joystick_center) {
                camera.options.lockX = false;
                camera.options.lockY = false;
            }
        }).on('dir:up dir:down', function () {
            if (!(camera.options.lockX || camera.options.lockY)) {
                camera.options.lockY = true;
            }
        }).on('dir:left dir:right', function () {
            if (!(camera.options.lockX || camera.options.lockY)) {
                camera.options.lockX = true;
            }
        });
    }

    function moveCamera(tilt, pan) {
        //Get the latest position from the last data_object
        let _pan = cameraPanTiltCmd.pan;
        let _tilt = cameraPanTiltCmd.tilt;
        _pan += scale(Math.floor(pan), 0, 100, 0, 200);
        if (_pan < pca_params.pan['minimum']) _pan = pca_params.pan['minimum'];
        if (_pan > pca_params.pan['maximum']) _pan = pca_params.pan['maximum'];
        _tilt += scale(Math.floor(tilt), 0, 100, 0, 200);
        if (_tilt < pca_params.tilt['minimum']) _tilt = pca_params.tilt['minimum'];
        if (_tilt > pca_params.tilt['maximum']) _tilt = pca_params.tilt['maximum'];

        cameraPanTiltCmd.pan = Math.floor(_pan);
        cameraPanTiltCmd.tilt = Math.floor(_tilt);
        cmd_stub.data = cameraPanTiltCmd;
        wssSend(cmd_stub, sentry_socket);
    }

    function centerCamera() {
        //Get the zeros for pan and tilt from the config.
        cameraPanTiltCmd.pan = pca_params.pan.init;
        cameraPanTiltCmd.tilt = pca_params.tilt.init;
        cmd_stub.data = cameraPanTiltCmd;
        wssSend(cmd_stub, sentry_socket);
    }


    /***
     * Cameras on/off
     */

    function cameraStartStopInit() {

        document.getElementById('camera_start').onclick = () => {
            document.getElementById("display_image").src = window.location.origin + ':5000/video';
        }

        document.getElementById('camera_stop').onclick = () => {
            document.getElementById("display_image").src = window.location.origin + "/siteicon.png";
        }
        document.getElementById("display_image").src = window.location.origin + ':5000/video';
    }

    /***
     * Track specific stuff
     */
    let moveFwdCmd = {
        "ina": 0,
        "inb": 65535,
        "inc": 65535,
        "ind": 0
    };
    let moveRevCmd = {
        "ina": 65535,
        "inb": 0,
        "inc": 0,
        "ind": 65535
    };

    let motorSpeed = {
        "ena": 0,
        "enb": 0
    }

    let rotateRightCmd = {
        "ena": 65535,
        "enb": 65535,
        "ina": 65535,
        "inb": 0,
        "inc": 65535,
        "ind": 0
    };
    let rotateLeftCmd = {
        "ena": 65535,
        "enb": 65535,
        "ina": 0,
        "inb": 65535,
        "inc": 0,
        "ind": 65535
    };

    let stopCmd = {
        "ena": 0,
        "enb": 0
    };


    const track = nipplejs.create({
        zone: document.getElementById('track'),
        mode: 'semi',
        color: 'green',
        size: 200
    });

    let lastAngle = 0;
    let lastDistance = 0;
    let moveReady = true;
    let moveRate = 250 // milliseconds

    function trackInit() {


        document.getElementById('track_all_stop').onclick = stopTrack;

        document.getElementById('track_rotate_left').addEventListener('mouseup', stopTrack);
        document.getElementById('track_rotate_left').addEventListener('touchend', stopTrack);
        document.getElementById('track_rotate_left').addEventListener('mousedown', rotateLeft);
        document.getElementById('track_rotate_left').addEventListener('touchstart', rotateLeft);

        document.getElementById('track_rotate_right').addEventListener('mouseup', stopTrack);
        document.getElementById('track_rotate_right').addEventListener('touchend', stopTrack);
        document.getElementById('track_rotate_right').addEventListener('mousedown', rotateRight);
        document.getElementById('track_rotate_right').addEventListener('touchstart', rotateRight);


        //track.on('end', function (evt, data) {
        track.on('end', function () {
            stopTrack();
        }).on('move', function (evt, data) {
            if (moveReady) {
                moveReady = false;
                moveTrack(data.angle.degree, data.distance);
                //Rate limit the move command a little
                setTimeout(() => {
                    moveReady = true
                }, moveRate);
            }

        });
    }

    function stopTrack() {
        cmd_stub.data = stopCmd;
        wssSend(cmd_stub, sentry_socket);
    }


    function rotateRight() {
        cmd_stub.data = rotateRightCmd;
        wssSend(cmd_stub, sentry_socket);
    }

    function rotateLeft() {
        cmd_stub.data = rotateLeftCmd;
        wssSend(cmd_stub, sentry_socket);
    }

    function moveTrack(angle, distance) {
        const currentAngle = Math.abs((lastAngle - angle) % 360) > 5;
        const currentDistance = Math.abs(lastDistance - distance) > 10;
        //Has the thumb position changed.
        if (currentAngle) {
            lastAngle = angle;
            if (angle < 180) {
                cmd_stub.data = moveFwdCmd;
            } else {
                cmd_stub.data = moveRevCmd;
            }
            wssSend(cmd_stub, sentry_socket);
        }
        //need current angle to look for turns
        if (currentDistance || currentAngle) {
            lastDistance = distance;
            setMotorSpeed(angle, distance);
        }
    }

    function setMotorSpeed(angle, distance) {
        //Assume ena controls rh motor (looking from rear to forward
        if (angle < 90) {
            //forward turning to the right - slow down right track
            motorSpeed.enb = parseInt(scale(distance, 0, 100, 15000, 65535));
            motorSpeed.ena = parseInt(scale(distance * (angle / 90), 0, 100, 15000, 65535));
        } else if (angle < 180) {
            //forward turning to the left
            motorSpeed.ena = parseInt(scale(distance, 0, 100, 15000, 65535));
            motorSpeed.enb = parseInt(scale(distance * (1 - (angle - 90) / 90), 0, 100, 15000, 65535));
        } else if (angle < 270) {
            //reverse turing to the left
            motorSpeed.ena = parseInt(scale(distance, 0, 100, 15000, 65535));
            motorSpeed.enb = parseInt(scale(distance * ((angle - 180) / 90), 0, 100, 15000, 65535));
        } else {
            //reverse turning to the right
            motorSpeed.enb = parseInt(scale(distance, 0, 100, 15000, 65535));
            motorSpeed.ena = parseInt(scale(distance * (1 - (angle - 270) / 90), 0, 100, 15000, 65535));
        }
        cmd_stub.data = motorSpeed;
        wssSend(cmd_stub, sentry_socket);
    }


</script>
</body>
</html>








